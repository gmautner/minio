name: IAM integration

# NOTE: OpenID tests are disabled because they require MinIO's custom Dex image.
# To re-enable:
#   1. Set up your own Dex configuration (see .github/workflows/iam/dex-config.yaml)
#   2. Build and host a custom Dex image with LDAP connector configured
#   3. Add the openid service back to the services section
#
# Current tests: LDAP (osixia/openldap) and etcd (quay.io/coreos/etcd)

on:
  pull_request:
    branches:
      - master

# This ensures that previous jobs for the PR are canceled when the PR is
# updated.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  iam-matrix-test:
    name: "[Go=${{ matrix.go-version }}|ldap=${{ matrix.ldap }}|etcd=${{ matrix.etcd }}]"
    runs-on: ubuntu-latest

    services:
      openldap:
        image: osixia/openldap:1.5.0
        ports:
          - "389:389"
          - "636:636"
        env:
          LDAP_ORGANISATION: "MinIO Inc"
          LDAP_DOMAIN: "min.io"
          LDAP_ADMIN_PASSWORD: "admin"
          LDAP_TLS: "false"
          LDAP_REMOVE_CONFIG_AFTER_SETUP: "false"
        options: >-
          --health-cmd "ldapsearch -x -H ldap://localhost -b dc=min,dc=io -D cn=admin,dc=min,dc=io -w admin"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      etcd:
        image: quay.io/coreos/etcd:v3.5.1
        env:
          ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
          ETCD_ADVERTISE_CLIENT_URLS: "http://0.0.0.0:2379"
        ports:
          - "2379:2379"
        options: >-
          --health-cmd "etcdctl endpoint health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        go-version: [1.24.x]
        ldap: ["", "localhost:389"]
        etcd: ["", "http://localhost:2379"]
        exclude:
          # exclude combo where both are empty
          - ldap: ""
            etcd: ""

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          check-latest: true
      - name: Bootstrap LDAP test data
        if: matrix.ldap != ''
        run: |
          # Wait for LDAP to be ready
          sleep 10
          # Add test users and groups
          ldapadd -x -H ldap://localhost:389 -D "cn=admin,dc=min,dc=io" -w admin -f docs/distributed/samples/bootstrap-complete.ldif || true
      - name: Test LDAP/Etcd combo
        env:
          _MINIO_LDAP_TEST_SERVER: ${{ matrix.ldap }}
          _MINIO_ETCD_TEST_SERVER: ${{ matrix.etcd }}
        run: |
          sudo sysctl net.ipv6.conf.all.disable_ipv6=0
          sudo sysctl net.ipv6.conf.default.disable_ipv6=0
          make test-iam
      - name: Test with Access Management Plugin enabled
        env:
          _MINIO_LDAP_TEST_SERVER: ${{ matrix.ldap }}
          _MINIO_ETCD_TEST_SERVER: ${{ matrix.etcd }}
          _MINIO_POLICY_PLUGIN_TEST_ENDPOINT: "http://127.0.0.1:8080"
        run: |
          sudo sysctl net.ipv6.conf.all.disable_ipv6=0
          sudo sysctl net.ipv6.conf.default.disable_ipv6=0
          go run docs/iam/access-manager-plugin.go &
          make test-iam
      - name: Test LDAP for automatic site replication
        if: matrix.ldap == 'localhost:389'
        run: |
          make test-site-replication-ldap

  iam-import-with-missing-entities:
    name: Test IAM import in new cluster with missing entities
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: 1.24.x
          check-latest: true
      - name: Checkout minio-iam-testing
        uses: actions/checkout@v6
        with:
          repository: minio/minio-iam-testing
          path: minio-iam-testing
      - name: Test import of IAM artifacts when in fresh cluster there are missing groups etc
        run: |
          make test-iam-import-with-missing-entities

  # NOTE: This test is disabled because it requires OpenID configuration
  # iam-import-with-openid:
  #   name: Test IAM import in new cluster with openid configurations
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v6
  #     - uses: actions/setup-go@v6
  #       with:
  #         go-version: 1.24.x
  #         check-latest: true
  #     - name: Checkout minio-iam-testing
  #       uses: actions/checkout@v6
  #       with:
  #         repository: minio/minio-iam-testing
  #         path: minio-iam-testing
  #     - name: Test import of IAM artifacts when in fresh cluster with openid configurations
  #       run: |
  #         make test-iam-import-with-openid
